const SESSION_KEY = "lexiflow:session";

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || "http://localhost:8080/api/v1";

const request = async (path, options = {}) => {
  const session = readSession();
  const headers = {
    "Content-Type": "application/json",
    ...(options.headers ?? {})
  };
  if (session?.sessionToken) {
    headers.Authorization = `Bearer ${session.sessionToken}`;
  }

  const response = await fetch(`${API_BASE_URL}${path}`, {
    headers,
    credentials: "include",
    ...options
  });

  if (!response.ok) {
    let message = "Request failed";
    try {
      const data = await response.json();
      message = data.error ?? message;
    } catch {
      // ignore parsing errors
    }
    throw new Error(message);
  }

  if (response.status === 204) {
    return null;
  }

  const data = await response.json();
  return data;
};

const persistSession = (user) => {
  if (typeof window === "undefined") return;
  window.localStorage.setItem(SESSION_KEY, JSON.stringify(user));
};

export const readSession = () => {
  if (typeof window === "undefined") return null;
  const raw = window.localStorage.getItem(SESSION_KEY);
  if (!raw) return null;
  try {
    return JSON.parse(raw);
  } catch {
    return null;
  }
};

export const clearSession = () => {
  if (typeof window === "undefined") return;
  window.localStorage.removeItem(SESSION_KEY);
};

const normaliseUser = (payload) => {
  if (!payload) return null;
  const stored = readSession();
  const sessionToken = payload.sessionToken ?? stored?.sessionToken ?? null;
  return {
    id: payload.id,
    companyName: payload.companyName,
    email: payload.email,
    verified: Boolean(payload.verified),
    subscription: payload.subscription ?? "starter",
    role: payload.role ?? stored?.role ?? "client",
    createdAt: payload.createdAt,
    sessionToken
  };
};

export const register = async ({ companyName, email, password, plan, role }) => {
  const { user } = await request("/auth/register", {
    method: "POST",
    body: JSON.stringify({ companyName, email, password, plan, role })
  });
  const normalised = normaliseUser(user);
  persistSession(normalised);
  return normalised;
};

export const apiRequest = request;

export const login = async ({ email, password }) => {
  const { user } = await request("/auth/login", {
    method: "POST",
    body: JSON.stringify({ email, password })
  });
  const normalised = normaliseUser(user);
  persistSession(normalised);
  return normalised;
};

export const verifyEmail = async ({ email, code }) => {
  const { user } = await request("/auth/verify-email", {
    method: "POST",
    body: JSON.stringify({ email, code })
  });
  const normalised = normaliseUser(user);
  persistSession(normalised);
  return normalised;
};

export const updateSubscription = async ({ email, plan }) => {
  const { user } = await request("/auth/subscription", {
    method: "POST",
    body: JSON.stringify({ email, plan })
  });
  const normalised = normaliseUser(user);
  persistSession(normalised);
  return normalised;
};

export const apiRequest = request;
